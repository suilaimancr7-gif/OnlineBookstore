@page "/orders"
@using OnlineBookstore.Domain.Entities
@using OnlineBookstore.Infrastructure.Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@rendermode InteractiveServer
@inject IGenericRepository<Order> OrderRepo
@inject NavigationManager NavigationManager

<PageTitle>Order Management</PageTitle>

<div class="container mt-4">
    <h1>All Customer Orders</h1>
    <hr />

    <table class="table table-hover align-middle shadow-sm rounded">
        <thead class="table-dark">
            <tr>
                <th>Order ID</th>
                <th>Customer ID</th>
                <th>Date</th>
                <th>Total Amount</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (orders != null)
            {
                @foreach (var order in orders)
                {
                    <tr>
                        <td>@order.Id</td>
                        <td>@order.CustomerId</td>
                        <td>@order.OrderDate.ToShortDateString()</td>
                        @* This property must be added to your Order.cs entity to avoid errors *@
                        <td>@order.TotalAmount.ToString("C")</td>
                        <td class="text-center">
                            <div class="btn-group">
                                @* Use route parameter format /id to avoid 404 *@
                                <a href="@($"/orders/details/{@order.Id}")" class="btn btn-outline-info btn-sm">Details</a>

                                <AuthorizeView Roles="Administrator">
                                    <Authorized>
                                        @* Matches @page "/orders/edit/{id:int}" route parameter format *@
                                        <a href="@($"/orders/edit/{@order.Id}")" class="btn btn-outline-warning btn-sm mx-1">Edit</a>
                                        <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteOrder(order.Id)">Delete</button>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@code {
    private List<Order> orders = new();

    protected override async Task OnInitializedAsync()
    {
        // Fetches all orders from SQL Server
        var data = await OrderRepo.GetAll();
        orders = data.ToList();
    }

    private async Task DeleteOrder(int id)
    {
        // Admin delete functionality using repository pattern
        await OrderRepo.Delete(id);
        var data = await OrderRepo.GetAll();
        orders = data.ToList();
    }
}