@page "/books/details"
@using OnlineBookstore.Domain.Entities
@using OnlineBookstore.Infrastructure.Contracts
@using OnlineBookstore.Infrastructure.Services
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@rendermode InteractiveServer
@inject IGenericRepository<Book> BookRepo
@inject CartService CartService
@inject NavigationManager NavigationManager

@if (book != null)
{
    <div class="container mt-4">
        <div class="row shadow p-4 rounded bg-white">
            <div class="col-md-4 text-center">
                <img src="@book.ImageLink" class="img-fluid rounded shadow" style="max-height: 400px;" />
            </div>
            <div class="col-md-8">
                <h1>@book.Title</h1>
                <p class="lead">@book.Description</p>

                <div class="card p-3 my-4 bg-light">
                    <h5>Select Format:</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fmt" id="p" value="Physical" @onchange="HandleChange">
                        <label class="form-check-label" for="p">Physical Copy - @((decimal)book.PricePhysical)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="fmt" id="s" value="Softcopy" @onchange="HandleChange">
                        <label class="form-check-label" for="s">Soft Copy - @((decimal)book.PriceSoftcopy)</label>
                    </div>
                </div>

                <button class="btn btn-success btn-lg w-100" disabled="@(string.IsNullOrEmpty(SelectedFormat))" @onclick="AddToCart">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }
    private Book? book;
    private string? SelectedFormat;

    protected override async Task OnInitializedAsync() => book = await BookRepo.Get(q => q.Id == Id);
    private void HandleChange(ChangeEventArgs e) => SelectedFormat = e.Value?.ToString();
    private void AddToCart()
    {
        if (book != null && SelectedFormat != null)
        {
            CartService.AddToCart(book, SelectedFormat);
            NavigationManager.NavigateTo("/cart");
        }
    }
}