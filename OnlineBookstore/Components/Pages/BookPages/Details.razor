@page "/books/details"
@using OnlineBookstore.Domain.Entities
@using OnlineBookstore.Infrastructure.Contracts
@using Microsoft.AspNetCore.Authorization
@rendermode InteractiveServer
@attribute [Authorize]
@inject IGenericRepository<Book> BookRepo
@inject NavigationManager NavigationManager

<PageTitle>Book Details</PageTitle>

@if (book == null)
{
    <div class="text-center mt-5">
        <div class="spinner-border text-primary" role="status"></div>
        <p>Loading...</p>
    </div>
}
else
{
    <div class="container mt-4">
        <div class="row shadow p-4 rounded bg-white">
            <div class="col-md-4">
                <img src="@book.ImageLink" class="img-fluid rounded shadow" style="max-height: 400px; object-fit: cover;" onerror="this.src='/favicon.png';" />
            </div>
            <div class="col-md-8">
                <h1>@book.Title</h1>
                <p class="lead">@book.Description</p>

                <div class="card p-3 my-4 bg-light">
                    <h5>Select Format:</h5>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="radio" name="bookFormat" id="phys" value="Physical"
                               @onchange="HandleFormatChange">
                        <label class="form-check-label" for="phys">
                            Physical Copy - <strong>@book.PricePhysical.ToString("C")</strong>
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="bookFormat" id="soft" value="Softcopy"
                               @onchange="HandleFormatChange">
                        <label class="form-check-label" for="soft">
                            Soft Copy (E-Book) - <strong>@book.PriceSoftcopy.ToString("C")</strong>
                        </label>
                    </div>
                </div>

                @if (string.IsNullOrEmpty(SelectedFormat))
                {
                    <div class="alert alert-warning py-2 small">
                        Please select a format to enable the Add to Cart button.
                    </div>
                }

                <button class="btn btn-success btn-lg w-100"
                        disabled="@(string.IsNullOrEmpty(SelectedFormat))"
                        @onclick="AddToCart">
                    Add to Cart
                </button>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] private int Id { get; set; }
    private Book? book;
    private string? SelectedFormat;

    protected override async Task OnInitializedAsync()
    {
        // Finding by ID using lambda to fix CS1503
        book = await BookRepo.Get(q => q.Id == Id);
    }

    private void HandleFormatChange(ChangeEventArgs e)
    {
        SelectedFormat = e.Value?.ToString();
    }

    private void AddToCart()
    {
        // Logic for Sunday: Save SelectedFormat to your cart list
        NavigationManager.NavigateTo("/books");
    }
}