@page "/books/create"
@using OnlineBookstore.Domain.Entities
@using OnlineBookstore.Infrastructure.Contracts
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin, Administrator")]
@rendermode InteractiveServer
@inject IGenericRepository<Book> BookRepo
@inject IGenericRepository<Author> AuthorRepo
@inject IGenericRepository<Genre> GenreRepo
@inject NavigationManager NavigationManager

<PageTitle>Admin | Add New Book</PageTitle>

<div class="container mt-4">
    <div class="card shadow border-0">
        <div class="card-header bg-primary text-white py-3">
            <h4 class="mb-0"><i class="bi bi-plus-square"></i> Add New Book to Inventory</h4>
        </div>
        <div class="card-body p-4">
            @* Added FormName and Model to ensure clear delegate conversion *@
            <EditForm Model="NewBook" OnValidSubmit="HandleCreate" FormName="createBookForm">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-danger" />

                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label class="form-label fw-bold">Book Title</label>
                        <InputText @bind-Value="NewBook.Title" class="form-control" placeholder="Enter book title" />
                        <ValidationMessage For="@(() => NewBook.Title)" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">ISBN</label>
                        <InputText @bind-Value="NewBook.ISBN" class="form-control" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold">Physical Price</label>
                        <InputNumber @bind-Value="NewBook.PricePhysical" class="form-control" />
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold text-primary">Initial Stock</label>
                        @* Fixed CS1662 by ensuring proper binding for nullable int? *@
                        <InputNumber @bind-Value="NewBook.StockQuantity" class="form-control border-primary" />
                        <ValidationMessage For="@(() => NewBook.StockQuantity)" />
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Genre</label>
                        <InputSelect @bind-Value="NewBook.GenreId" class="form-select">
                            <option value="">-- Select Genre --</option>
                            @if (Genres != null)
                            {
                                @foreach (var genre in Genres)
                                {
                                    <option value="@genre.Id">@genre.Name</option>
                                }
                            }
                        </InputSelect>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label fw-bold">Author</label>
                        <InputSelect @bind-Value="NewBook.AuthorId" class="form-select">
                            <option value="">-- Select Author --</option>
                            @if (Authors != null)
                            {
                                @foreach (var author in Authors)
                                {
                                    @* FIXED CS1061: Changed author.FirstName to author.Name *@
                                    <option value="@author.Id">@author.Name</option>
                                }
                            }
                        </InputSelect>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Cover Image URL</label>
                    <InputText @bind-Value="NewBook.ImageLink" class="form-control" />
                </div>

                <div class="mt-4 d-flex gap-2">
                    <button type="submit" class="btn btn-success px-5 fw-bold">Confirm and Add Book</button>
                    <a href="/books" class="btn btn-secondary px-4">Cancel</a>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    private Book NewBook = new();
    private List<Author> Authors = new();
    private List<Genre> Genres = new();

    protected override async Task OnInitializedAsync()
    {
        // Load data from SQL Server
        var authorData = await AuthorRepo.GetAll();
        Authors = authorData?.ToList() ?? new List<Author>();

        var genreData = await GenreRepo.GetAll();
        Genres = genreData?.ToList() ?? new List<Genre>();
    }

    private async Task HandleCreate()
    {
        try
        {
            await BookRepo.Insert(NewBook); // Create in database
            NavigationManager.NavigateTo("/books");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }
}