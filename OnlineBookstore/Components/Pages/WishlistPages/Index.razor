@page "/wishlist"
@using OnlineBookstore.Domain.Entities
@using OnlineBookstore.Infrastructure.Contracts
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@attribute [Authorize]
@rendermode InteractiveServer
@inject IGenericRepository<Wishlist> WishlistRepo
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>My Wishlist</PageTitle>

<div class="container mt-4">
    <h1>My Wishlist</h1>
    <hr />

    @if (WishlistItems == null)
    {
        <p><em>Loading your favorites...</em></p>
    }
    else if (!WishlistItems.Any())
    {
        <div class="alert alert-info">Your wishlist is empty. Browse books to add items!</div>
    }
    else
    {
        <table class="table table-hover shadow-sm border">
            <thead class="table-dark">
                <tr>
                    <th>Book Title</th> @* Displaying the Title here *@
                    <th>Date Added</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in WishlistItems)
                {
                    <tr>
                        <td class="fw-bold">@item.Book?.Title</td> @* Book title in the wishlist *@
                        <td>@item.DateAdded.ToShortDateString()</td>
                        <td class="text-center">
                            <div class="btn-group">
                                <a href="@($"/wishlist/details?id={item.Id}")" class="btn btn-outline-info btn-sm">Details</a>
                                @* Edit button has been removed from here *@
                                <button class="btn btn-outline-danger btn-sm" @onclick="() => HandleDelete(item.Id)">Remove</button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>

@code {
    private List<Wishlist>? WishlistItems;

    protected override async Task OnInitializedAsync() => await LoadData();

    private async Task LoadData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userId = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;

        // Using Include to ensure the Book title is loaded from the database
        var data = await WishlistRepo.GetAll(
            expression: w => w.CustomerId == userId,
            includes: q => q.Include(w => w.Book)
        );
        WishlistItems = data.ToList();
    }

    private async Task HandleDelete(int id)
    {
        await WishlistRepo.Delete(id);
        await LoadData();
    }
}